{% extends "base.html" %}

{% block title %}Dashboard - Bakery Sensors{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Sensor Overview</h2>
    
    <!-- Global Chart Controls -->
    {% if categorized_sensor_ids %}
    <div style="margin-bottom: 0.75rem; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: #002B5B; margin: 0;">Categorized Sensor Data Overview</h3>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="hourly-average-control">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #002B5B; cursor: pointer;">
                        <input type="checkbox" id="hourlyAverageCheckbox" checked style="cursor: pointer;">
                        <span>Average over hour</span>
                    </label>
                </div>
                <div class="time-slice-controls">
                    <button class="time-slice-btn" data-slice="4h" onclick="updateAllCharts('4h')">4h</button>
                    <button class="time-slice-btn" data-slice="8h" onclick="updateAllCharts('8h')">8h</button>
                    <button class="time-slice-btn active" data-slice="12h" onclick="updateAllCharts('12h')">12h</button>
                    <button class="time-slice-btn" data-slice="24h" onclick="updateAllCharts('24h')">24h</button>
                    <button class="time-slice-btn" data-slice="7d" onclick="updateAllCharts('7d')">7d</button>
                    <button class="time-slice-btn" data-slice="30d" onclick="updateAllCharts('30d')">30d</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Categorized Chart Containers -->
    <div class="chart-section" style="margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="color: #002B5B; margin: 0 0 1rem 0;">Freezer Sensors</h3>
        <div style="height: 250px;">
            <canvas id="freezerChart"></canvas>
        </div>
    </div>

    <div class="chart-section" style="margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="color: #002B5B; margin: 0 0 1rem 0;">Refrigerator Sensors</h3>
        <div style="height: 250px;">
            <canvas id="refrigeratorChart"></canvas>
        </div>
    </div>

    <div class="chart-section" style="margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="color: #002B5B; margin: 0 0 1rem 0;">Ambient Sensors</h3>
        <div style="height: 250px;">
            <canvas id="ambientChart"></canvas>
        </div>
    </div>
    {% endif %}
    
    {% if sensors_data %}
        <div class="sensor-grid">
            {% for sensor_data in sensors_data %}
                <div class="sensor-card{% if sensor_data.is_stale %} stale-sensor{% endif %}">
                    <div class="sensor-name">
                        <span class="status-indicator {% if sensor_data.sensor.active %}status-active{% else %}status-inactive{% endif %}"></span>
                        {{ sensor_data.sensor.name }}
                    </div>
                    
                    {% if sensor_data.latest_reading %}
                        {% set threshold = sensor_data.threshold_info %}
                        
                        <!-- Threshold Alert Banner -->
                        {% if threshold.has_breach %}
                            <div class="threshold-alert threshold-{{ threshold.breach_type }}">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <span class="alert-text">
                                    {% if threshold.temperature_breach and threshold.humidity_breach %}
                                        Temperature and humidity thresholds breached
                                    {% elif threshold.temperature_breach %}
                                        Temperature threshold breached ({{ threshold.temperature_breach }})
                                    {% elif threshold.humidity_breach %}
                                        Humidity threshold breached ({{ threshold.humidity_breach }})
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                        
                        <div class="reading-info">
                            <span>Temperature:</span>
                            <span class="reading-value temperature {% if threshold.temperature_breach %}breach-{{ threshold.temperature_breach }}{% endif %}">
                                {{ "%.1f"|format(sensor_data.latest_reading.temperature) }}¬∞C
                                {% if threshold.temperature_breach %}
                                    <span class="breach-indicator">
                                        {% if threshold.temperature_breach == 'high' %}üî•{% else %}‚ùÑÔ∏è{% endif %}
                                    </span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="reading-info">
                            <span>Humidity:</span>
                            <span class="reading-value humidity {% if threshold.humidity_breach %}breach-{{ threshold.humidity_breach }}{% endif %}">
                                {{ "%.1f"|format(sensor_data.latest_reading.humidity) }}%
                                {% if threshold.humidity_breach %}
                                    <span class="breach-indicator">
                                        {% if threshold.humidity_breach == 'high' %}üíß{% else %}üèúÔ∏è{% endif %}
                                    </span>
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="timestamp">
                            Last updated: {{ sensor_data.latest_reading.timestamp|localtime }}
                            {% if sensor_data.is_stale %}
                                <span class="stale-indicator">‚è∞ Stale!</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="no-data">No recent readings available</div>
                    {% endif %}
                    
                    <a href="/sensor/{{ sensor_data.sensor.sensor_id }}" class="btn-primary btn">View Details</a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-data">
            <h3>No active sensors found</h3>
            <p>Make sure the polling service is running and sensors are configured.</p>
        </div>
    {% endif %}
    
</div>


{% if categorized_sensor_ids %}
<script>
// Categorized dashboard chart functionality
let currentGlobalTimeSlice = '12h';
let currentGlobalHourlyAverage = true;

// Get categorized sensor IDs for the dashboard charts
var freezerSensorIds = {{ categorized_sensor_ids.freezer | tojson }};
var refrigeratorSensorIds = {{ categorized_sensor_ids.refrigerator | tojson }};
var ambientSensorIds = {{ categorized_sensor_ids.ambient | tojson }};
var otherSensorIds = {{ categorized_sensor_ids.other | tojson }}; // Include 'other' for completeness, though it might not have a dedicated chart initially

// Keep the original structure for backward compatibility with existing chart functions
const categorizedSensorIds = {
    'freezer': freezerSensorIds,
    'refrigerator': refrigeratorSensorIds,
    'ambient': ambientSensorIds,
    'other': otherSensorIds
};

function updateAllCharts(timeSlice) {
    currentGlobalTimeSlice = timeSlice;
    
    // Update button states
    document.querySelectorAll('.time-slice-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('[data-slice="' + timeSlice + '"]').classList.add('active');
    
    renderCategorizedCharts();
}

function handleGlobalHourlyAverageChange() {
    currentGlobalHourlyAverage = document.getElementById('hourlyAverageCheckbox').checked;
    renderCategorizedCharts();
}

function renderCategorizedCharts() {
    // Call the new function in charts.js to render all three charts
    renderAllCategorizedCharts(
        categorizedSensorIds,
        currentGlobalTimeSlice,
        currentGlobalHourlyAverage
    );
}

// Initialize categorized dashboard charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing categorized dashboard charts...');
    console.log('Categorized sensor IDs:', categorizedSensorIds);
    
    // Add event listener to hourly average checkbox
    const hourlyAverageCheckbox = document.getElementById('hourlyAverageCheckbox');
    if (hourlyAverageCheckbox) {
        hourlyAverageCheckbox.addEventListener('change', handleGlobalHourlyAverageChange);
    }
    
    updateAllCharts('12h'); // Initial render
});
</script>
{% endif %}
{% endblock %}