{% extends "base.html" %}

{% block title %}Sensor Settings - Manager Panel{% endblock %}

{% block head %}
    <style>
        /* Manager Sensor Settings Modern Styles */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 203, 110, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.6);
        }

        .manager-actions {
            text-align: right;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .success-message {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #00a085;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #e55353;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .sensor-name-management {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .sensor-name-management::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00b894, #00cec9, #74b9ff, #0984e3);
            background-size: 300% 100%;
            animation: gradient 3s ease infinite;
        }

        .sensor-name-management h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        .sensor-name-management p {
            color: #636e72;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 16px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .sensor-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 300% 100%;
            animation: gradient 3s ease infinite;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .sensor-name {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .sensor-id {
            font-size: 14px;
            color: #636e72;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .status-inactive {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #ffffff;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .threshold-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            color: white;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .threshold-section h4 {
            color: white;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .threshold-section .form-group input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .threshold-section .form-group input:focus {
            background: white;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .collapsible {
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .collapsible-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .collapsible-content {
            padding: 0 20px 20px;
            display: none;
        }

        .collapsible.active .collapsible-content {
            display: block;
        }

        .collapsible-toggle {
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .collapsible.active .collapsible-toggle {
            transform: rotate(180deg);
        }

        .no-sensors {
            text-align: center;
            padding: 60px;
            color: #636e72;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .no-sensors h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .sensor-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
            
            .manager-actions {
                flex-direction: column;
                align-items: center;
            }

            .container {
                margin: 10px;
                padding: 20px;
            }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating animation for cards */
        .sensor-card {
            animation: float 6s ease-in-out infinite;
        }

        .sensor-card:nth-child(2n) {
            animation-delay: -2s;
        }

        .sensor-card:nth-child(3n) {
            animation-delay: -4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
{% endblock %}

{% block header %}Sensor Management{% endblock %}
{% block content %}
    <!-- Manager Sensor Settings Actions -->
    <div class="manager-actions">
        <a href="{{ url_for('manager_settings') }}" class="btn btn-secondary">Back to Settings</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Dashboard</a>
    </div>

    {% if success %}
        <div class="success-message">
            {{ success }}
        </div>
    {% endif %}

    {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
    {% endif %}

    <!-- Refetch Sensor Names Section -->
    <div class="sensor-name-management">
        <h3>Sensor Name Management</h3>
        <p>
            Refetch sensor names from the SensorPush API to update any changes made in the SensorPush app or web interface.
            This will update the names of existing sensors in your local database to match those in your SensorPush account.
        </p>
        <button type="button" id="refetchSensorNamesBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            🔄 Refetch Sensor Names
        </button>
    </div>

        <div class="sensor-grid">
            {% for sensor in sensors %}
                <div class="sensor-card">
                    <div class="sensor-header">
                        <div>
                            <div class="sensor-name">{{ sensor.name }}</div>
                            <div class="sensor-id">ID: {{ sensor.sensor_id }}</div>
                        </div>
                        <span class="status-badge {% if sensor.active %}status-active{% else %}status-inactive{% endif %}">
                            {% if sensor.active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>

                    <!-- Rename Sensor -->
                    <div class="collapsible">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <span>Rename Sensor</span>
                            <span class="collapsible-toggle">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <form method="POST" action="{{ url_for('manager_sensor_settings') }}">
                                <input type="hidden" name="sensor_id" value="{{ sensor.sensor_id }}">
                                <input type="hidden" name="action" value="rename">
                                <div class="form-group">
                                    <label for="new_name_{{ sensor.sensor_id }}">New Name</label>
                                    <input 
                                        type="text" 
                                        id="new_name_{{ sensor.sensor_id }}" 
                                        name="new_name" 
                                        value="{{ sensor.name }}"
                                        required
                                    >
                                </div>
                                <button type="submit" class="btn-primary btn-small">Update Name</button>
                            </form>
                        </div>
                    </div>

                    <!-- Threshold Settings -->
                    <div class="collapsible">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <span>Threshold Settings</span>
                            <span class="collapsible-toggle">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <form method="POST" action="{{ url_for('manager_sensor_settings') }}">
                                <input type="hidden" name="sensor_id" value="{{ sensor.sensor_id }}">
                                <input type="hidden" name="action" value="update_thresholds">
                                
                                <div class="threshold-section">
                                    <h4>Temperature Thresholds (°C)</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="min_temp_{{ sensor.sensor_id }}">Minimum</label>
                                            <input 
                                                type="number" 
                                                id="min_temp_{{ sensor.sensor_id }}" 
                                                name="min_temp" 
                                                value="{{ sensor.min_temp }}"
                                                step="0.1"
                                                required
                                            >
                                        </div>
                                        <div class="form-group">
                                            <label for="max_temp_{{ sensor.sensor_id }}">Maximum</label>
                                            <input 
                                                type="number" 
                                                id="max_temp_{{ sensor.sensor_id }}" 
                                                name="max_temp" 
                                                value="{{ sensor.max_temp }}"
                                                step="0.1"
                                                required
                                            >
                                        </div>
                                    </div>
                                </div>

                                <div class="threshold-section">
                                    <h4>Humidity Thresholds (%)</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="min_humidity_{{ sensor.sensor_id }}">Minimum</label>
                                            <input 
                                                type="number" 
                                                id="min_humidity_{{ sensor.sensor_id }}" 
                                                name="min_humidity" 
                                                value="{{ sensor.min_humidity }}"
                                                step="0.1"
                                                min="0"
                                                max="100"
                                                required
                                            >
                                        </div>
                                        <div class="form-group">
                                            <label for="max_humidity_{{ sensor.sensor_id }}">Maximum</label>
                                            <input 
                                                type="number" 
                                                id="max_humidity_{{ sensor.sensor_id }}" 
                                                name="max_humidity" 
                                                value="{{ sensor.max_humidity }}"
                                                step="0.1"
                                                min="0"
                                                max="100"
                                                required
                                            >
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn-primary btn-small">Update Thresholds</button>
                            </form>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <form method="POST" action="{{ url_for('manager_sensor_settings') }}" style="display: inline;">
                            <input type="hidden" name="sensor_id" value="{{ sensor.sensor_id }}">
                            <input type="hidden" name="action" value="toggle_active">
                            {% if sensor.active %}
                                <button type="submit" class="btn-warning btn-small" onclick="return confirm('Are you sure you want to deactivate this sensor?')">
                                    Deactivate
                                </button>
                            {% else %}
                                <button type="submit" class="btn-success btn-small">
                                    Activate
                                </button>
                            {% endif %}
                        </form>
                        
                        <a href="{{ url_for('sensor_detail', sensor_id=sensor.sensor_id) }}" class="btn btn-secondary btn-small">
                            View Details
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% if not sensors %}
        <div class="no-sensors">
            <h3>No sensors found</h3>
            <p>Sensors will appear here once the polling service discovers them.</p>
        </div>
    {% endif %}

    <script>
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('active');
        }

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const action = form.querySelector('input[name="action"]');
                    if (!action) return; // Skip forms without action input
                    
                    if (action.value === 'update_thresholds') {
                        const minTemp = parseFloat(form.querySelector('input[name="min_temp"]').value);
                        const maxTemp = parseFloat(form.querySelector('input[name="max_temp"]').value);
                        const minHumidity = parseFloat(form.querySelector('input[name="min_humidity"]').value);
                        const maxHumidity = parseFloat(form.querySelector('input[name="max_humidity"]').value);
                        
                        if (minTemp >= maxTemp) {
                            e.preventDefault();
                            alert('Minimum temperature must be less than maximum temperature');
                            return false;
                        }
                        
                        if (minHumidity >= maxHumidity) {
                            e.preventDefault();
                            alert('Minimum humidity must be less than maximum humidity');
                            return false;
                        }
                    }
                });
            });

            // Refetch Sensor Names functionality
            const refetchBtn = document.getElementById('refetchSensorNamesBtn');
            if (refetchBtn) {
                refetchBtn.addEventListener('click', async function() {
                    // Confirm action
                    if (!confirm('This will update sensor names from the SensorPush API. Continue?')) {
                        return;
                    }

                    // Disable button and show loading state
                    const originalText = refetchBtn.innerHTML;
                    refetchBtn.disabled = true;
                    refetchBtn.innerHTML = '⏳ Refetching...';

                    try {
                        const response = await fetch('/manager/sensors/refetch_names', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });

                        if (response.ok) {
                            // Success - reload the page to show updated sensor names
                            window.location.reload();
                        } else {
                            // Handle HTTP error responses
                            const errorData = await response.json().catch(() => ({}));
                            const errorMessage = errorData.error || `Server error: ${response.status} ${response.statusText}`;
                            alert(`Error refetching sensor names: ${errorMessage}`);
                        }
                    } catch (error) {
                        // Handle network or other errors
                        console.error('Error refetching sensor names:', error);
                        alert('Error refetching sensor names: Network error or server unavailable');
                    } finally {
                        // Re-enable button and restore original text
                        refetchBtn.disabled = false;
                        refetchBtn.innerHTML = originalText;
                    }
                });
            }
        });
    </script>
{% endblock %}